/*!
 * medium-editor-insert-plugin v0.1.1 - jQuery insert plugin for MediumEditor
 *
 * Embed Addon
 *
 * https://github.com/orthes/medium-editor-images-plugin
 *
 * Copyright (c) 2013 Pavel Linkesch (http://linkesch.sk)
 * Released under the MIT license
 */
!function(a){"use strict";a.fn.mediumInsert.registerAddon("embed",{init:function(b){b&&b.$el&&(this.$el=b.$el),this.options=a.extend(this.default,b)},"default":{supportedProviders:["youtube","vimeo"],unsupportedURL:function(a){console.error("un-supported url",a)},loadingCallback:a.noop,onSuccess:a.noop,onError:a.noop,onComplete:a.noop,embedlyKey:null},setInputboxEvents:function(){var b=this;this.$input.click(function(b){b.stopPropagation(),a.fn.mediumInsert.settings.editor.deactivateTextEditor()}),this.$input.keydown(function(a){(a.ctrlKey||a.metaKey)&&65===a.which&&(a.preventDefault(),this.select())}),this.$input.focus(function(b){b.stopPropagation(),a.fn.mediumInsert.settings.editor.deactivateTextEditor()}),this.$input.keyup(function(c){13===c.which&&(c.stopPropagation(),a(document.body).off("click",a.fn.mediumInsert.insert.hideMediumInput),b.isSupported(this.value)?b.getEmbedCode(this.value):(a(document.body).on("click",a.fn.mediumInsert.insert.hideMediumInput),b.options.unsupportedURL(this.value)))})},insertButton:function(a){var b="Embed";return"fontawesome"===a&&(b='<i class="fa fa-film"></i>'),'<button data-addon="embed" data-action="add" class="medium-editor-action medium-editor-action-embed mediumInsert-action">'+b+"</button>"},add:function(b,c){this.placeholder=c,a.fn.mediumInsert.insert.deselect(),this.showInputBox(b,this.placeholder)},showInputBox:function(b,c){b.stopPropagation();var d=a(".mediumInsert-embed-input-url");d.length>0&&d.parent().detach(),this.$mediumInsertEmbed=a('<div class="mediumInsert-embed medium-arrow-right"></div>'),this.$input=a('<input class="mediumInsert-embed-input-url mediumInsert-input" placeholder="Paste or type a video link">'),this.setInputboxEvents(),c.prepend(this.$mediumInsertEmbed.prepend(this.$input)),this.$input.focus()},isSupported:function(a){var b=!1;if(/\.(gif|jpg|jpeg|tiff|png)$/i.test(a))return!0;for(var c=this.options.supportedProviders,d=this.options.supportedProviders.length;d>=0;){if(-1!==a.toLowerCase().indexOf(c[d])){b=!0;break}d--}return b},cancel:function(){return this.promise?this.promise.reject([{error:!0,error_message:"abort"}]):void 0},getEmbedCode:function(b){var c=this,d=a(".mediumInsert-embed-input-url");d.prop("disabled",!0).addClass("loading"),this.options.loadingCallback(d),this.promise=a.embedly.extract([b],{key:this.options.embedlyKey}),this.promise.done(function(a){if(!a[0].error){if(d.parent().detach(),0!==c.placeholder.children().length){var b,e=c.placeholder.parent();e.prev("p").before("<p><br><p>"),c.$el.keyup(),b=e.prevAll(".mediumInsert").first(),c.placeholder=b.find(".mediumInsert-placeholder")}c.options.onSuccess(a[0],c.placeholder)}}),this.promise.always(function(b){a(document.body).on("click",a.fn.mediumInsert.insert.hideMediumInput),d.removeClass("loading"),b[0].error&&(d.prop("disabled",!1),d.focus(),c.options.onError(b[0])),c.options.onComplete(b[0])})}})}(jQuery);